---
phase: 03-deal-workflows
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docx-tools/core/writer.py
  - docx-tools/core/calendar_writer.py
  - skills/sara/references/deal-workflows.md
  - skills/sara/references/work-product-standards.md
  - skills/sara/SKILL.md
autonomous: true
requirements:
  - DEAL-01

must_haves:
  truths:
    - "write_docx renders tables from structured data (headers + rows) with proper formatting"
    - "write_docx renders ordered and unordered lists from markdown list syntax"
    - "calendar_writer.py generates a valid multi-VEVENT .ics file from a list of date/summary/description events"
    - "Sara's SKILL.md references deal workflows and SARA.md persistence"
    - "deal-workflows.md defines the closing checklist workflow with all 5 steps"
    - "work-product-standards.md includes closing checklist and deal calendar standards"
  artifacts:
    - path: "docx-tools/core/writer.py"
      provides: "Table rendering and list support in write_docx"
      contains: "_render_table"
    - path: "docx-tools/core/calendar_writer.py"
      provides: ".ics calendar file generation"
      contains: "generate_ics"
    - path: "skills/sara/references/deal-workflows.md"
      provides: "Deal workflow behavioral specifications"
      contains: "Workflow 1: Closing Checklist"
    - path: "skills/sara/references/work-product-standards.md"
      provides: "Standards for closing checklist and deal calendar"
      contains: "Closing Checklist"
    - path: "skills/sara/SKILL.md"
      provides: "Deal workflow references and SARA.md persistence"
      contains: "SARA.md"
  key_links:
    - from: "skills/sara/references/deal-workflows.md"
      to: "skills/sara/SKILL.md"
      via: "SKILL.md references deal-workflows.md for deal assignments"
      pattern: "deal-workflows\\.md"
    - from: "skills/sara/references/deal-workflows.md"
      to: "docx-tools/core/writer.py"
      via: "Checklist workflow instructs Sara to use write_docx with table data"
      pattern: "write_docx"
    - from: "skills/sara/references/deal-workflows.md"
      to: "docx-tools/core/calendar_writer.py"
      via: "Checklist workflow instructs Sara to generate .ics via calendar_writer"
      pattern: "generate_ics|calendar"
---

<objective>
Build the closing checklist workflow foundation: enhance write_docx with table and list rendering, create the .ics calendar writer utility, define the closing checklist workflow in a new deal-workflows.md reference file, add SARA.md deal context persistence to SKILL.md, and update work-product-standards.md with closing checklist and deal calendar standards.

Purpose: This plan creates the shared tooling (tables, lists, calendar) and behavioral infrastructure (deal-workflows.md, SARA.md persistence, work-product-standards) that all three deal workflows depend on, plus the complete Workflow 1 (closing checklist) specification.

Output: Enhanced writer.py, new calendar_writer.py, new deal-workflows.md (with Workflow 1 complete, Workflow 2 and 3 as stubs), updated SKILL.md, updated work-product-standards.md.
</objective>

<execution_context>
@/home/david/.claude/get-shit-done/workflows/execute-plan.md
@/home/david/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-deal-workflows/03-RESEARCH.md
@skills/sara/SKILL.md
@skills/sara/references/work-product-standards.md
@docx-tools/core/writer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance write_docx with table rendering and list support, create calendar_writer.py</name>
  <files>
    docx-tools/core/writer.py
    docx-tools/core/calendar_writer.py
  </files>
  <action>
**writer.py enhancements:**

1. Add a `_render_table()` function that takes a Document, headers list, rows list (each row is a list of cell strings), and an optional style name. Implementation:
   - Create table with `doc.add_table(rows=1, cols=len(headers))`
   - Try to apply the style parameter; fall back to 'Table Grid'; silently skip if neither available
   - Bold the header row text by iterating header cell paragraphs and setting `run.bold = True`
   - Add data rows via `table.add_row().cells` and set cell text
   - Return the table object

2. Update `_render_markdown_to_docx()` to detect and render tables and lists:
   - **Tables:** Detect markdown table syntax (lines starting with `|`). Accumulate consecutive pipe-delimited lines. Parse headers from the first row, skip the separator row (`|---|`), parse data rows. Call `_render_table()` with the parsed data. Handle the separator row detection with a regex like `^\|[\s\-:|]+\|$`.
   - **Ordered lists:** Detect lines matching `^\d+\.\s+(.+)$`. Use `doc.add_paragraph(text, style='List Number')` for each item. For templates that may not have 'List Number' style, fall back to adding a paragraph with the number prefix preserved.
   - **Unordered lists:** Detect lines matching `^[-*]\s+(.+)$`. Use `doc.add_paragraph(text, style='List Bullet')` for each item. Same fallback pattern.
   - Apply `_add_inline_markdown()` to table cell text, list item text, and regular paragraphs (already done for paragraphs).

3. Add necessary imports at the top: `from docx.shared import Pt, Inches` (already present), and any needed for table operations. No new external dependencies.

**calendar_writer.py (new file):**

Create `docx-tools/core/calendar_writer.py` implementing the .ics generator from the research document (Example 2). Specifically:
- `generate_ics(events, output_path, calendar_name="Deal Calendar")` function
- Each event dict has keys: `date` (YYYY-MM-DD string), `summary`, `description` (optional)
- Generate RFC 5545 compliant VCALENDAR with multi-VEVENT entries
- All-day events: DTSTART;VALUE=DATE and DTEND;VALUE=DATE (next day)
- Proper text escaping via `_ics_escape()`: backslash, comma, semicolon, newline
- UID generation using `uuid.uuid4().hex[:12]`
- CRLF line endings per RFC 5545
- `_next_day()` helper for DTEND calculation
- No external dependencies (uses uuid, datetime, pathlib from stdlib)

Also create `docx-tools/cli/calendar.py` as a thin CLI wrapper:
- Accept `--events` (JSON string or path to JSON file) and `--output` (output path)
- Parse events, call `generate_ics()`, print the output path
- Usage: `python docx-tools/cli/calendar.py --events '[{"date":"2026-04-15","summary":"DD Expiry","description":"Section 4.1"}]' --output calendar.ics`
  </action>
  <verify>
Run from the project root:
```bash
cd /home/david/projects/AI-Associate && source docx-tools/.venv/bin/activate
python -c "
from docx_tools.core.writer import write_docx
# Test table rendering
content = '''# Test Document

| Header 1 | Header 2 | Header 3 |
|----------|----------|----------|
| Cell 1   | Cell 2   | Cell 3   |
| Cell 4   | Cell 5   | Cell 6   |

1. First item
2. Second item

- Bullet one
- Bullet two
'''
write_docx(content, '/tmp/test-table.docx')
from docx import Document
doc = Document('/tmp/test-table.docx')
assert len(doc.tables) == 1, f'Expected 1 table, got {len(doc.tables)}'
assert len(doc.tables[0].rows) == 3, f'Expected 3 rows (1 header + 2 data), got {len(doc.tables[0].rows)}'
print('writer.py: Table and list rendering OK')
"
python -c "
from docx_tools.core.calendar_writer import generate_ics
path = generate_ics([
    {'date': '2026-04-15', 'summary': 'DD Expiry', 'description': 'Section 4.1'},
    {'date': '2026-05-30', 'summary': 'Closing Date', 'description': 'Section 6.1'},
], '/tmp/test-calendar.ics')
with open(path) as f:
    content = f.read()
assert 'BEGIN:VCALENDAR' in content
assert content.count('BEGIN:VEVENT') == 2
assert 'DTSTART;VALUE=DATE:20260415' in content
print('calendar_writer.py: .ics generation OK')
"
python docx-tools/cli/calendar.py --events '[{"date":"2026-04-15","summary":"Test","description":"Test desc"}]' --output /tmp/test-cli-calendar.ics
```
All three commands should succeed without errors.
  </verify>
  <done>
write_docx renders markdown tables as Word tables with bold headers and proper cell content. write_docx renders ordered lists as 'List Number' paragraphs and unordered lists as 'List Bullet' paragraphs. calendar_writer.py generates valid multi-VEVENT .ics files. CLI wrapper works for calendar generation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create deal-workflows.md with Workflow 1, update SKILL.md and work-product-standards.md</name>
  <files>
    skills/sara/references/deal-workflows.md
    skills/sara/SKILL.md
    skills/sara/references/work-product-standards.md
  </files>
  <action>
**deal-workflows.md (new file):**

Create `skills/sara/references/deal-workflows.md` with the following structure. This is the behavioral specification that Sara loads when she receives a deal workflow assignment. Follow the same tone and specificity as `contract-review-workflow.md`.

```
# Deal Workflows

Sara handles deal workflows beyond contract review: closing checklists, title objection letters, and closing document drafting. Each workflow is independently invokable and follows common patterns.

## Common Patterns

### SARA.md Deal Context Persistence
[Define the SARA.md read/write protocol per research Example 3:]
- Location: SARA.md in the project root directory
- Structure: Deal Summary, Key Dates table, Extracted Provisions, Work Product Log, Issues Flagged
- Reading rules: always read at start of any deal workflow; use it instead of re-reading source docs
- Writing rules: update Deal Summary only when new info supersedes; always APPEND to Work Product Log and Issues Flagged; never delete existing entries
- Creation: created on first deal workflow from source document extraction

### Placeholder Handling
- Sara uses [BRACKETED PLACEHOLDERS] for information she cannot determine from available documents
- All placeholders are listed in the cover note / milestone check-in
- Sara continues with placeholders rather than blocking on missing information

### Cover Note Pattern
- Every deal workflow output includes a cover note identifying:
  - Provisions requiring partner review
  - Deal-specific insertions that need verification
  - Provisions Sara could not populate from available documents
  - Proactive issue flags (concerning provisions Sara noticed while extracting)

### File Naming Convention
- Deal-specific file naming: [doc-type]-[property-shortname].[ext]
- Examples: checklist-123-main-st.docx, calendar-123-main-st.ics, deed-123-main-st.docx

### Style Matching
- When user provides a template, match the template's fonts, formatting, margins
- When no template is provided, use write_docx defaults (Times New Roman 12pt, standard margins)

### Interaction Model
- Simpler than PSA reviews: Sara asks only what she cannot infer from documents
- Representation: infer from context, confirm only if ambiguous
- Milestone check-ins at natural checkpoints before generating final docs
- Sara presents extracted data for partner verification, then produces output

## Workflow 1: Closing Checklist from PSA

### Purpose
Generate a deal-specific closing checklist and calendar from a finalized PSA. The checklist is organized by responsible party with deadlines populated from the contract.

### Input
- PSA document (required)
- Checklist template .docx (optional -- user provides for style matching)
- SARA.md (if it exists from prior workflow)

### Output
- Closing checklist .docx (table format, organized by responsible party)
- Deal calendar .ics file (multi-VEVENT, key milestones)
- Updated SARA.md

### Steps

#### Step 1: Read PSA and Extract Deal Terms
1. Read SARA.md if it exists (reuse previously extracted context)
2. Read PSA using read_docx or extract_structure
3. Extract:
   - Parties (buyer, seller, escrow agent, title company, lender if applicable)
   - Property description
   - Purchase price, deposit amounts, earnest money details
   - All deadlines and time periods (convert relative dates to absolute where possible)
   - Responsible party for each obligation
   - Conditions to closing
   - Post-closing obligations
   - PSA section references for each extracted item
4. Create or update SARA.md with extracted deal context

#### Step 2: Build Checklist Items by Responsible Party
Organize extracted items into categories by responsible party:

**Buyer Responsibilities:** DD inspections, title objection letter, additional deposits, financing commitments, closing deliverables (buyer certificates, authorization docs), post-closing items

**Seller Responsibilities:** Title commitment delivery, survey delivery, tenant estoppels, seller certificates, cure of title objections, closing deliverables (deed, assignment, FIRPTA affidavit), post-closing items (adjustments, document delivery)

**Escrow/Title Company:** Title commitment issuance, pro forma title policy, closing statement, recording, policy issuance

**Lender (if applicable):** Commitment letter, loan documents, funding

Each checklist item must include ALL of these columns per the user's locked decision:
- Item description (specific to this PSA, not generic)
- Deadline (absolute date or relative period from PSA)
- PSA section reference
- Status column (default: Pending)
- Notes column (include dependency flags here, e.g., "Depends on receipt of title commitment")

**Quality check:** If the checklist has fewer than 15 items for a standard PSA, Sara has likely been too generic. Go back to the PSA and extract deal-specific items.

#### Step 3: Milestone Check-in (Deadline Verification)
Present the extracted deadlines and responsible party assignments to the partner:
> "I've extracted [N] checklist items from the PSA organized by responsible party. Key milestones: [list top 5 dates]. Here's the summary -- do the deadlines look right before I generate the checklist?"

Wait for confirmation or corrections. Apply any corrections.

#### Step 4: Generate Checklist .docx and Calendar .ics

**Checklist .docx:**
- If template provided: use write_docx with template_path for style matching
- Embed Key Dates section at top of checklist (milestone table with date, PSA reference)
- Then checklist items organized by responsible party, each as a table with the 6 columns
- Use write_docx table rendering for all tables

**Calendar .ics:**
- Generate using calendar_writer.py (CLI: `python ${CLAUDE_PLUGIN_ROOT}/docx-tools/cli/calendar.py`)
- Include key milestone dates only (not every checklist item): DD expiry, title objection deadline, closing date, post-closing deadlines
- Typically 4-8 events
- Multi-VEVENT format for single Outlook import

**File naming:** checklist-[property-shortname].docx, calendar-[property-shortname].ics

#### Step 5: Update SARA.md
- Update Deal Summary if new information was extracted
- Append to Work Product Log: date, "Closing Checklist", output file names, item count and milestone count
- Append to Issues Flagged: any concerning provisions noticed during extraction

## Workflow 2: Title Objection Letter from Title Commitment

[STUB -- completed in Plan 03-02]

### Purpose
Review a title commitment, categorize exceptions, and produce a title objection letter with a companion title summary memo.

### Input
- Title commitment (required)
- PSA (optional -- for cross-reference and objection deadline)
- Survey (optional -- for cross-reference)
- Letter template .docx (optional)
- SARA.md (if it exists)

### Output
- Title objection letter .docx
- Title summary memo .docx
- Updated SARA.md

### Steps
[To be defined in Plan 03-02]

## Workflow 3: Closing Documents from PSA

[STUB -- completed in Plan 03-03]

### Purpose
Draft standard closing documents from a finalized PSA: deed, assignment and assumption, estoppel certificates, escrow holdback agreement.

### Input
- PSA (required)
- SARA.md (if it exists)
- Jurisdiction/state (optional -- Sara asks if not provided and cannot be inferred)

### Output
- Individual document files (deed.docx, assignment.docx, estoppel-[tenant].docx, holdback.docx)
- Cover note
- Updated SARA.md

### Steps
[To be defined in Plan 03-03]
```

Adapt the above to be precise and actionable. The full workflow steps should be detailed enough that Sara (or an executor) can follow them without ambiguity. Use the same writing standards as contract-review-workflow.md.

**SKILL.md updates:**

Add the following sections to SKILL.md:

1. **Deal Workflows section** (after the "Milestone Check-Ins" section or after "Work Product" section -- wherever it fits logically): Add a section that tells Sara about deal workflows, when to use them, and where to find the reference file. Include:
   - "For deal workflow assignments (closing checklists, title objection letters, closing document drafting), follow the structured workflows in `${CLAUDE_PLUGIN_ROOT}/skills/sara/references/deal-workflows.md`."
   - Brief description of the 3 workflows and when Sara activates each
   - Reference to SARA.md persistence

2. **SARA.md section** (within the Deal Workflows section or as a subsection): Add the SARA.md persistence protocol:
   - Sara reads SARA.md at the start of any deal workflow
   - Sara creates SARA.md on the first deal workflow for a deal
   - Sara updates SARA.md after each workflow (append to Work Product Log, update key terms if new info)
   - SARA.md location: project root directory

3. **Update "Additional Resources" section** at the bottom: Add deal-workflows.md to the reference file list

4. **Update "Document Types" section**: Add closing checklists, title objection letters, closing documents, and deal calendars to the list of document types Sara produces

5. **Update the skill description in frontmatter**: Add deal workflow trigger phrases so Sara activates for "generate a closing checklist", "review this title commitment", "draft closing documents", "prepare deal calendar" etc.

**work-product-standards.md updates:**

Add sections for new document types:

1. **Closing Checklist** section (after "Summaries and Analyses"):
   - Structure: Key Dates table at top, then items by responsible party (Buyer, Seller, Escrow/Title, Lender), each as a table
   - Column standards: Item, Deadline, PSA Ref, Status (Pending/Received/Waived), Notes
   - Dependencies noted in Notes column
   - Quality standard: every item tied to specific PSA provision; no generic entries
   - Minimum 15 items for a standard PSA

2. **Deal Calendar (.ics)** section:
   - Contains key milestones only (4-8 events typical)
   - All-day events (not timed)
   - Description field includes PSA section reference
   - File naming: calendar-[property-shortname].ics

3. **Title Objection Letter** section (stub -- fleshed out in 03-02):
   - Brief placeholder noting the standard exists

4. **Title Summary Memo** section (stub -- fleshed out in 03-02):
   - Brief placeholder

5. **Closing Documents** section (stub -- fleshed out in 03-03):
   - Brief placeholder

6. **Cover Note (Deal Workflows)** section:
   - Structure: per-document section listing partner review items, verification items, unfilled placeholders, proactive issue flags
   - Standards: every closing document draft includes a cover note; cover note distinguishes "needs partner review" from "needs factual verification"
  </action>
  <verify>
Verify all files exist and contain required content:
```bash
# deal-workflows.md exists and has Workflow 1
grep -c "Workflow 1" skills/sara/references/deal-workflows.md
grep -c "SARA.md" skills/sara/references/deal-workflows.md
grep -c "Step 1:" skills/sara/references/deal-workflows.md

# SKILL.md references deal workflows
grep -c "deal-workflows.md" skills/sara/SKILL.md
grep -c "SARA.md" skills/sara/SKILL.md

# work-product-standards.md has new sections
grep -c "Closing Checklist" skills/sara/references/work-product-standards.md
grep -c "Deal Calendar" skills/sara/references/work-product-standards.md
grep -c "Cover Note" skills/sara/references/work-product-standards.md
```
All grep counts should be >= 1.
  </verify>
  <done>
deal-workflows.md exists with complete Workflow 1 specification (5 steps), SARA.md persistence protocol, common patterns, and stubs for Workflows 2 and 3. SKILL.md references deal workflows and SARA.md persistence. work-product-standards.md includes closing checklist, deal calendar, and cover note standards.
  </done>
</task>

</tasks>

<verification>
1. write_docx can render a markdown table into a Word document table with bold headers
2. write_docx can render ordered and unordered lists
3. calendar_writer.py generates valid .ics files with multiple VEVENTs
4. deal-workflows.md defines Workflow 1 with all 5 steps and SARA.md persistence
5. SKILL.md references deal-workflows.md and describes SARA.md persistence
6. work-product-standards.md includes standards for closing checklists, deal calendars, and cover notes
</verification>

<success_criteria>
- A test script can generate a .docx with tables and lists using write_docx
- A test script can generate a multi-VEVENT .ics file using calendar_writer.py
- deal-workflows.md Workflow 1 is detailed enough for Sara to follow without ambiguity
- SKILL.md tells Sara when and how to use deal workflows
- work-product-standards.md defines quality standards for all new document types
</success_criteria>

<output>
After completion, create `.planning/phases/03-deal-workflows/03-01-SUMMARY.md`
</output>
